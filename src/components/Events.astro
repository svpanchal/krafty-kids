---
import events from "../data/events.json";

/**
 * Helpers
 */
const formatDate = (iso: string) => {
  try {
    return new Date(`${iso}T00:00:00`).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  } catch {
    return iso;
  }
};

const mapsUrlFromAddress = (address?: string) => {
  if (!address) return "";
  return `https://maps.google.com/?q=${encodeURIComponent(address)}`;
};

/**
 * Build-time sort for stable output.
 * Live (runtime) hiding happens in the inline script.
 */
const sorted = [...events].sort(
  (a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime(),
);

/**
 * Maya controls "isUpcoming" in JSON.
 * We additionally hide past events at runtime (day after).
 */
const upcomingAll = sorted.filter((e) => e.isUpcoming);

/**
 * Tint classes rotate for event cards.
 * Script will re-apply these to visible cards after runtime filtering.
 */
const tintClasses = [
  "bg-[var(--brand-peach)]/35",
  "bg-[var(--brand-lilac)]/20",
  "bg-[var(--brand-emerald-tint)]",
];

const evergreen = {
  ctaLabel: "Request a workshop",
  ctaUrl: "#contact",
};
---

<section id="events" class="py-20 md:py-24 bg-[var(--brand-peach)]/25">
  <div class="container">
    <header class="mx-auto mb-10 md:mb-12 max-w-3xl text-center">
      <p class="section-kicker">Events</p>
      <h2 class="section-title mt-3 text-3xl md:text-5xl">
        Upcoming sessions and community events
      </h2>
      <p class="mt-4 text-slate-600">
        Our workshops are designed using research-backed social-emotional
        learning practices and refined with participant feedback.
      </p>
    </header>

    <div class="mb-2 md:mb-4">
      {/* Empty state (JS can reveal this if everything is in the past) */}
      <div
        id="events-empty"
        class="rounded-2xl border border-black/5 p-6 md:p-8 bg-white shadow-sm hidden"
      >
        <p class="text-slate-700">
          No upcoming events are posted yet. We are planning our next sessions
          now. Please check back soon or reach out if you would like to host a
          workshop.
        </p>
        <a
          href="#contact"
          class="mt-4 inline-flex items-center rounded-xl
            bg-white px-4 py-2 text-sm font-semibold text-slate-900
            ring-1 ring-black/10 shadow-sm
            transition-colors duration-200
            hover:bg-[var(--brand-peach)]/80 hover:text-[var(--brand-coral)]
            hover:ring-[var(--brand-coral)]/70 hover:shadow-md"
        >
          Get in touch
        </a>
      </div>

      {
        /* Build-time empty state (when there are literally no upcoming items in JSON) */
      }
      {
        upcomingAll.length === 0 ? (
          <div class="rounded-2xl border border-black/5 p-6 md:p-8 bg-white shadow-sm">
            <p class="text-slate-700">
              No upcoming events are posted yet. We are planning our next
              sessions now. Please check back soon or reach out if you would
              like to host a workshop.
            </p>
            <a
              href="#contact"
              class="mt-4 inline-flex items-center rounded-xl
              bg-white px-4 py-2 text-sm font-semibold text-slate-900
              ring-1 ring-black/10 shadow-sm
              transition-colors duration-200
              hover:bg-[var(--brand-peach)]/80 hover:text-[var(--brand-coral)]
              hover:ring-[var(--brand-coral)]/70 hover:shadow-md"
            >
              Get in touch
            </a>
          </div>
        ) : (
          <div id="events-grid" class="grid gap-6 md:grid-cols-3">
            {upcomingAll.map((event, i) => {
              const mapsUrl =
                event.mapsUrl || mapsUrlFromAddress(event.address);

              return (
                <article
                  data-event-card
                  data-start-date={event.startDate}
                  data-tintable
                  class={`rounded-2xl p-7 md:p-8 shadow-sm ring-1 ring-black/5 ${
                    tintClasses[i % tintClasses.length]
                  }`}
                >
                  <div class="flex items-center justify-between gap-4">
                    <div class="text-sm text-slate-600">
                      {formatDate(event.startDate)}
                      {event.time ? ` â€¢ ${event.time}` : ""}
                    </div>

                    {event.partnerLogo && (
                      <div class="partner-badge" aria-hidden="true">
                        <img
                          src={event.partnerLogo}
                          alt=""
                          class="partner-logo"
                          loading="lazy"
                        />
                      </div>
                    )}
                  </div>

                  <h4 class="mt-2 text-lg font-semibold text-slate-900">
                    {event.title}
                  </h4>

                  {event.location && (
                    <div class="mt-1">
                      {mapsUrl ? (
                        <a
                          href={mapsUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="location-link text-sm font-semibold text-slate-800"
                        >
                          {event.location}
                        </a>
                      ) : (
                        <p class="text-sm font-semibold text-slate-800">
                          {event.location}
                        </p>
                      )}

                      {event.address && (
                        <p class="mt-0.5 text-xs text-slate-500">
                          {event.address}
                        </p>
                      )}

                      {mapsUrl && (
                        <a
                          href={mapsUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="mt-1 inline-block text-xs text-slate-500 underline underline-offset-2 hover:text-[var(--brand-coral)]"
                        >
                          View on map
                        </a>
                      )}
                    </div>
                  )}

                  {event.summary && (
                    <p class="mt-3 text-slate-700 leading-relaxed">
                      {event.summary}
                    </p>
                  )}

                  {event.ctaUrl && event.ctaLabel && (
                    <a
                      href={event.ctaUrl}
                      class="mt-4 inline-flex items-center rounded-xl
                      bg-white px-4 py-2 text-sm font-semibold text-slate-900
                      ring-1 ring-black/10 shadow-sm
                      transition-colors duration-200
                      hover:bg-[var(--brand-peach)]/80 hover:text-[var(--brand-coral)]
                      hover:ring-[var(--brand-coral)]/70 hover:shadow-md"
                    >
                      {event.ctaLabel}
                    </a>
                  )}
                </article>
              );
            })}

            {/* Evergreen CTA card: kept always, but JS will change layout based on how many events are visible */}
            <article
              data-evergreen-card
              class={`rounded-2xl p-7 md:p-8 shadow-sm ring-1 ring-black/5 ${tintClasses[2]}`}
            >
              <div class="flex items-center justify-between gap-4">
                <div class="text-sm text-slate-600">Partner with us</div>

                <div
                  class="partner-badge text-xl leading-none"
                  aria-hidden="true"
                  title="Grow with Krafty Kids"
                >
                  ðŸŒ±
                </div>
              </div>

              <h4 class="mt-2 text-lg font-semibold text-slate-900">
                Host a Krafty Kids workshop
              </h4>

              <p class="mt-3 text-slate-700 leading-relaxed">
                Bring a Krafty Kids workshop to your school, library, or
                community space. Weâ€™ll partner with you to create a thoughtful,
                joyful experience for the children you serve.
              </p>

              <a
                href={evergreen.ctaUrl}
                class="mt-4 inline-flex items-center rounded-xl
                bg-white px-4 py-2 text-sm font-semibold text-slate-900
                ring-1 ring-black/10 shadow-sm
                transition-colors duration-200
                hover:bg-[var(--brand-peach)]/80 hover:text-[var(--brand-coral)]
                hover:ring-[var(--brand-coral)]/70 hover:shadow-md"
              >
                {evergreen.ctaLabel}
              </a>
            </article>
          </div>
        )
      }
    </div>
  </div>

  <script is:inline>
    const TINTS = [
      "bg-[var(--brand-peach)]/35",
      "bg-[var(--brand-lilac)]/20",
      "bg-[var(--brand-emerald-tint)]",
    ];

    const startOfToday = () => {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    };

    const parseStartDate = (iso) => {
      if (!iso) return NaN;
      return new Date(`${iso}T00:00:00`).getTime();
    };

    const reTintVisibleCards = (visibleCards) => {
      visibleCards.forEach((card, idx) => {
        TINTS.forEach((c) => card.classList.remove(c));
        card.classList.add(TINTS[idx % TINTS.length]);
      });
    };

    const layoutEvergreenCard = (visibleCount) => {
      const evergreen = document.querySelector("[data-evergreen-card]");
      if (!evergreen) return;

      // If we have 3+ visible events, make evergreen a full-width CTA row.
      if (visibleCount >= 3) {
        evergreen.classList.add("md:col-span-3");
      } else {
        evergreen.classList.remove("md:col-span-3");
      }
    };

    const hidePastEventCards = () => {
      const today = startOfToday();
      const cards = Array.from(document.querySelectorAll("[data-event-card]"));

      const visibleCards = [];
      for (const card of cards) {
        const iso = card.getAttribute("data-start-date") || "";
        const ts = parseStartDate(iso);

        const isPast = Number.isFinite(ts) ? ts < today : false;
        if (isPast) {
          card.style.display = "none";
        } else {
          card.style.display = "";
          visibleCards.push(card);
        }
      }

      const grid = document.getElementById("events-grid");
      const empty = document.getElementById("events-empty");

      if (grid && empty) {
        if (visibleCards.length === 0) {
          grid.style.display = "none";
          empty.classList.remove("hidden");
        } else {
          grid.style.display = "";
          empty.classList.add("hidden");
        }
      }

      // Keep colors consistent after hiding events
      reTintVisibleCards(visibleCards);

      // Make evergreen behave like a tile when there are 1-2 events,
      // or a full-width CTA row when there are 3+ events.
      layoutEvergreenCard(visibleCards.length);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", hidePastEventCards);
    } else {
      hidePastEventCards();
    }
  </script>

  <style>
    .partner-badge {
      height: 56px;
      width: 56px;
      border-radius: 12px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      display: grid;
      place-items: center;
      padding: 6px;
      flex: 0 0 auto;
    }

    .partner-logo {
      height: 100%;
      width: 100%;
      object-fit: contain;
      display: block;
    }

    .location-link {
      text-decoration: none;
    }

    .location-link:hover {
      color: var(--brand-coral);
      text-decoration: underline;
      text-underline-offset: 3px;
    }
  </style>
</section>
